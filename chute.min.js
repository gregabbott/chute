/*https://github.com/gregabbott/chute By + (C) Greg Abbott 2024. V: 2024-11-29*/
const chute=(()=>{let e=[];const n=(...e)=>n=>(console.log(...e),n&&console.log(n),n),t=(...e)=>{throw new Error(e)},r=e=>e instanceof Function,i=e=>r(globalThis[e]),f=e=>{o._=e};let l=new Map,o=(e,...n)=>(f(e),n.length>0&&f(u(n,e)),_);function s(e){return e.name&&!i(e.name)&&(l.has(e.name)||l.set(e.name,e)),e}function a(e,n){if("log"===n)return console[n](e),e;if(r(n))return s(n),n(e);if((t=n)&&"object"==typeof t&&!Array.isArray(t)&&function(e){const n=e=>Array.isArray(e),t=Object.keys(e);if(!t.includes("if")||!n(e.if)||2!==e.if.length)return!1;const r=t.filter((e=>["else","else_if"].includes(e))).length;if("else_if"in e){if(!n(e.else_if))return!1;if(e.else_if.length>0&&!e.else_if.every((e=>n(e)&&2==e.length)))return!1}return 0==t.length-1-r&&r<=2}(n)){let t=function(e,n){function t(e,n){return r(e)?e(n):e}if([e.if,...e.else_if].forEach((([e,n])=>{r(e)&&s(e),r(n)&&s(n)})),"if"in e&&0 in e.if&&1 in e.if&&t(e.if[0],n))return e.if[1];if("else_if"in e)for(const n of e.else_if)if(0 in n&&1 in n&&t(n[0]))return n[1];return"else"in e?e.else:n}(n,e);return e===t?e:r(t)?c(t,e,[]):t}var t;return n}o.x={};const u=(e,n)=>e.reduce(a,n),h=new Set(["forEach","push","unshift"]),c=(e,n,t)=>{if(0===t.length)return e(n);let r=t.indexOf(o.x);return-1!==r?(t[r]=n,e(...t)):e(...t)(n)},g=(e,n,f)=>{if(s=e,a=n,r(Object.getPrototypeOf(s)[a])){let t=f.indexOf(o.x);-1!==t&&(f[t]=e);let r=e[n](...f);return h.has(n)?e:r}var s,a;if(i(n)){let t=globalThis[n];return c(t,e,f)}return l.has(n)?c(l.get(n),e,f):(t(`Data lacks "${n}" and not a global function`),e)},_=new Proxy(o,{get:(n,t)=>(e.push(t),_),apply:(i,l,a)=>{if(0==e.length)return 0===a.length?o._:(f(u(a,o._)),_);let h=e.length-1;return e.reduce(((i,l,_)=>e.length>1&&_!==h?("log"==l?n(o._)():"if"==l?t(".if needs 2 arguments"):"tap"==l?t(".tap needs 1 fn argument"):"do"===l?t(".do needs 1+ arguments"):l&&f(g(o._,l,[])),i):(1!==e.length&&_!==h||("log"==l?n(...a,o._)():"if"==l?f((({when:e,then:n,data:t})=>{let i=e;return r(e)&&(s(e),i=c(e,t,[])),i&&r(n)?(s(n),c(n,t,[])):i?n:t})({when:a[0],then:a[1],data:o._})):"tap"==l&&r(a[0])?a[0](o._):"tap"==l?t("give .tap a fn to send data to"):"do"===l?f(u(a,o._)):l&&f(g(o._,l,a)),e.length=0),i)),_)}});return o})();