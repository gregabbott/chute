/*https://gregabbott.github.io/chute By + (C) Greg Abbott 2024-2025. V: 2024-12-08.2*/
const chute=(()=>{const t=(...t)=>{throw new Error(t)},e=t=>t instanceof Function,a=t=>Array.isArray(t),n=t=>t&&"object"==typeof t&&!Array.isArray(t),r=t=>e=>{for(let a in e)if(!1===t(a,e[a],e))break},i={},s={},l=(t=s,...e)=>h({seed:t,args:e});l.make=(...e)=>{let a=1===e.length&&n(e[0])?e[0]:0;return a||t("Make takes 1 object for settings"),h({settings:a})};const o=({settings:a,a_chute:n})=>{let r=a;r.sync&&function(a,n){e(a)||t('give SYNC FN: "v=>user_variable=v"');n.sync_data=a,n.sync_data(n.get_data())}(r.sync,n),"skip"in r&&(n.skip_void=!!r.skip),r.path&&(n.treat_dots_as_paths=!!r.path)};l.x=s,l.library={},l.lifted_libraries=[],l.lift=e=>(n(e)||t("give .lift 1 object"),r(((t,e)=>{n(e)&&(l.library[t]=e,l.lifted_libraries.push(e))}))(e),l),l.feed=a=>(n(a)||t("give .feed 1 object"),r(((t,a)=>{(e(a)||n(a))&&(l.library[t]=a)}))(a),l),i.log=({args:t,data:e})=>(t.length>0?console.log(...t,e):console.log(e),e),i.do=({args:a,data:n,a_chute:r})=>(0==a.length&&t("give .do >0 arguments"),a.reduce(((t,a)=>"log"===a?(console.log(t),t):e(a)?(r.keep(a),a(t)):a),n));const d=t=>a=>{let n=a.name;return n&&!e(globalThis[n])&&!t.fns_seen[n]&&(t.fns_seen[n]=a),a},f=({fn:t,data:e,args:a})=>{if(0===a.length)return t(e);let n=u(a,e);return n!==a?t(...n):t(...a)(e)},u=(t,e)=>t.length>0&&t.includes(s)?t.map((t=>t===s?e:t)):t,_=new Set(["forEach","push","unshift"]);function c(a,n){let r=a.dot_list,s=a.get_data(),o=a.skip_void;let d=a.treat_dots_as_paths;return r.reduce(((e,s,o,f)=>{if(e.path||([e.root_string,e.root]=function(e,n){if(i.hasOwnProperty(e))return["chute_lib",i];if(null!==n.data&&void 0!==n.data[e])return["the_current_data",n.data];if(a.fns_seen[e])return["memoized_function",a.fns_seen];if(l.library[e])return["Feed_lib",l.library];let r=l.lifted_libraries.find((t=>t[e]));return r?["Lift_lib",r]:void 0!==globalThis[e]?["global_this",globalThis]:void t(`"${e}" is not: a built in chute method; a method of the_current_data; a function passed in to this chute via a previous call, or Chute's .feed or .lift properties;or a global function.`)}(s,e),e.path=e.root,e.context=e.root),e.path=e.path[s],o==f.length-1)return c({fn:e.path,key:s,a:e,args:n});let u=r[o+1];return void 0===e.path[u]?(d&&t(`"${s}" lacks "${u}"`),e.data=c({fn:e.path,key:s,a:e}),e.path=null):e.context=e.path,e}),{path:null,data:s,context:null,root:null});function c({fn:n,key:r,a:s,args:d=[]}){let c;return e(s.path)||t(`${s.root_string}…"${r}" not ƒ`),s.root==i?c=n({args:d,data:s.data,a_chute:a}):s.root===globalThis||s.root==a.fns_seen||s.root==l.library||"Lift_lib"==s.root_string?c=f({fn:n,data:s.data,args:d}):(c=n.call(s.context,...u(d,s.data)),c=_.has(r)?s.data:c),void 0===c&&o?s.data:c}}i.pick=({args:r,data:i,a_chute:s})=>{0==r.length&&t(".if needs 1-2 arguments");let l=2===r.length?{if:r}:1===r.length&&r[0];if((t=>{if(!n(t))return!1;if(!1 in t)return!1;const e=t=>a(t)&&2===t.length&&0 in t&&1 in t;let r=Object.entries(t).reduce(((t,[n,r])=>("if"==n&&a(r)&&e(r)?t.valid[n]=r:"else_if"==n?t[a(r)&&r.map(e).filter((t=>!t)).length<1?"valid":"invalid"][n]=r:"else"==n?t.valid[n]=r:t.invalid[n]=r,t)),{valid:{},invalid:{}});return 0===Object.keys(r.invalid).length})(l)){let t=((t,a,n)=>{function r({q:t,data:a}){return e(t)?t(a):t}if((t.else_if?[t.if,...t.else_if]:[t.if]).forEach((([t,a])=>{e(t)&&n.keep(t),e(a)&&n.keep(a)})),r({q:t.if[0],data:a}))return t.if[1];if("else_if"in t)for(let[e,n]of t.else_if)if(r({q:e,data:a}))return n;return"else"in t?(e(t.else)&&n.keep(t.else),t.else):a})(l,i,s);return i===t?i:e(t)?f({fn:t,data:i,args:[]}):t}return t(".if block incorrect",r),i},i.tap=({args:a,data:n})=>{let r=a[0];return e(r)?r(n):t("give .tap a fn to send data to"),n};function h({seed:t,args:e,settings:a}){let n={data:null,fns_seen:{},treat_dots_as_paths:!1,sync_data:null,skip_void:!0,dot_list:[]};return n.keep=d(n),n.set_data=t=>{void 0===t&&n.skip_void||(n.sync_data&&n.sync_data(t),n.data=t)},n.get_data=()=>n.data,a&&o({settings:a,a_chute:n}),t&&n.set_data(t),e?.length>0&&n.set_data(i.do({args:e,data:t,a_chute:n})),n.proxy=new Proxy((()=>{}),{get:(t,e)=>(function(t,e){t.dot_list.push(e)}(n,e),n.proxy),apply:(t,e,a)=>function(t,e){let a=["_end","_$"].includes(t.dot_list.at(-1));a&&t.dot_list.pop();let n,r=0==t.dot_list.length,s=r&&e.length>0,l=!r,o=r&&0===e.length||a,d=s||l;return s?n=i.do({args:e,data:t.get_data(),a_chute:t}):l&&(n=c(t,e)),d&&t.set_data(n),t.dot_list.length=0,o?t.get_data():t.proxy}(n,a)}),n.proxy}return l})();