/*https://gregabbott.github.io/chute By + (C) Greg Abbott 2024. V: 2024-12-07.2*/
const chute=(()=>{const t=(...t)=>{throw new Error(t)},e=t=>t instanceof Function,a=t=>Array.isArray(t),n=t=>t&&"object"==typeof t&&!Array.isArray(t),i=t=>e=>{for(let a in e)if(!1===t(a,e[a],e))break},r={},s={},o=(a,...n)=>function({seed:a,args:n}){let i={data:null,fns_seen:{},with_received:!1,treat_dots_as_paths:!1,sync_data:null,skip_void:!0};i.keep=function(t){return a=>{let n=a.name;return n&&!e(globalThis[n])&&!t.fns_seen[n]&&(t.fns_seen[n]=a),a}}(i),i.set_data=t=>{i.skip_void&&void 0===t||(i.sync_data&&i.sync_data(t),i.data=t)},i.get_data=()=>i.data,i.set_data(a),n.length>0&&i.set_data(r.do({args:n,data:a,a_chute:i}));const s=[];function l(t,e){return s.push(e),c}function d(a,n,l){let d=["_end","_$"].includes(s.at(-1));d&&s.pop();let f=0==s.length,g=f&&l.length>0,p=f&&0===l.length,v=s.length>0,b=p||d;return g&&i.set_data(r.do({args:l,data:i.get_data(),a_chute:i})),v&&i.set_data(function({keys:a,args:n,a_chute:i}){let s=i.get_data(),l=i.skip_void;function d(e,a){let n="a built in chute method, a method of the_current_data, a global function, a function passed in to this chute via a previous call, or Chute's .feed or .lift properties";if(r.hasOwnProperty(e))return["chute_lib",r];if(null!==a.data&&void 0!==a.data[e])return["the_current_data",a.data];if(i.fns_seen[e])return["memoized_function",i.fns_seen];if(o.library[e])return["Feed_lib",o.library];let s=o.lifted_libraries.find((t=>t[e]));return s?["Lift_lib",s]:void 0!==globalThis[e]?["global_this",globalThis]:void t(`"${e}" is not: ${n}`)}let c=i.treat_dots_as_paths;return a.reduce(((e,i,r,s)=>{if(e.path||([e.root_string,e.root]=d(i,e),e.path=e.root,e.context=e.root),e.path=e.path[i],r==s.length-1)return f({fn:e.path,key:i,a:e,args:n});let o=a[r+1];return void 0===e.path[o]&&(c&&t(`"${i}" lacks "${o}"`),e.data=f({fn:e.path,key:i,a:e}),e.path=null),e.context=e.path,e}),{path:null,data:s,context:null,root:null});function f({fn:a,key:n,a:s,args:d=[]}){let c;return e(s.path)||t(`${s.root_string}'s â€¦ "${n}" is not a FN`),s.root==r?c=a({args:d,data:s.data,a_chute:i}):s.root===globalThis||s.root==i.fns_seen||s.root==o.library||"Lift_lib"==s.root_string?c=u({fn:a,data:s.data,args:d}):(c=a.call(s.context,...h(d,s.data)),c=_.has(n)?s.data:c),l&&void 0===c?s.data:c}}({keys:s,a_chute:i,args:l})),s.length=0,b?i.get_data():c}let c=new Proxy((()=>{}),{get:l,apply:d});return c}({seed:a,args:n});o.x=s,o.library={},o.lifted_libraries=[];const l=(t,e)=>{n(e)&&(o.library[t]=e,o.lifted_libraries.push(e))};function d(e){n(e)||t("give .lift 1 object"),i(l)(e)}o.lift=d;const c=(t,a)=>{(e(a)||n(a))&&(o.library[t]=a)};function f(e){n(e)||t("feed accepts an objects"),i(c)(e)}o.feed=f,r.log=({args:t,data:e})=>(t.length>0?console.log(...t,e):console.log(e),e),r.do=({args:a,data:n,a_chute:i})=>(0==a.length&&t(".do needs 1+ arguments"),a.reduce(((t,a)=>"log"===a?(console.log(t),t):e(a)?(i.keep(a),a(t)):a),n));const u=({fn:t,data:e,args:a})=>{if(0===a.length)return t(e);let n=h(a,e);return n!==a?t(...n):t(...a)(e)},h=(t,e)=>t.length>0&&t.includes(s)?t.map((t=>t===s?e:t)):t,_=new Set(["forEach","push","unshift"]);r.if=({args:i,data:r,a_chute:s})=>{0==i.length&&t(".if needs 1-2 arguments");let o=2===i.length?{if:i}:1===i.length&&i[0];if(function(t){if(!n(t))return!1;if(!1 in t)return!1;const e=t=>a(t)&&2===t.length&&0 in t&&1 in t;let i=Object.entries(t).reduce(((t,[n,i])=>("if"==n&&a(i)&&e(i)?t.valid[n]=i:"else_if"==n?t[a(i)&&i.map(e).filter((t=>!t)).length<1?"valid":"invalid"][n]=i:"else"==n?t.valid[n]=i:t.invalid[n]=i,t)),{valid:{},invalid:{}});return 0===Object.keys(i.invalid).length}(o)){let t=function(t,a,n){function i({condition:t,data:a}){return e(t)?t(a):t}if((t.else_if?[t.if,...t.else_if]:[t.if]).forEach((([t,a])=>{e(t)&&n.keep(t),e(a)&&n.keep(a)})),i({condition:t.if[0],data:a}))return t.if[1];if("else_if"in t)for(const[e,n]of t.else_if)if(i({condition:e,data:a}))return n;return"else"in t?(e(t.else)&&n.keep(t.else),t.else):a}(o,r,s);return r===t?r:e(t)?u({fn:t,data:r,args:[]}):t}return t(".if block incorrect",i),r},r.tap=({args:a,data:n})=>{let i=a[0];return e(i)?i(n):t("give .tap a fn to send data to"),n},r.with=({args:a,data:i,a_chute:r})=>{let s=a;return r.with_received&&t("1 with per chute"),r.with_received=!0,1===s.length&&n(s[0])||t(".with accepts 1 object for settings"),s=s[0],s.sync&&function(a,n){e(a)||t('"sync" takes "v=>external_variable=v"');n.sync_data=a,n.sync_data(n.get_data())}(s.sync,r),s.skip_void&&(r.skip_void=!!s.skip_void),s.feed&&f(s.feed),s.lift&&d(s.lift),s.path&&(r.treat_dots_as_paths=!!s.path),i};return o})();