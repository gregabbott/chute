/*https://gregabbott.github.io/chute By + (C) Greg Abbott 2024. V: 2024-12-03.1*/
const chute=(()=>{const e=[],n=(...e)=>{throw new Error(e)},t=e=>e instanceof Function,r=e=>"number"==typeof e&&!isNaN(e),i=e=>Array.isArray(e),o=e=>e&&"object"==typeof e&&!Array.isArray(e),l=e=>t(globalThis[e]),a=new Map,f={},u=(f,...u)=>function({seed:f,fns:u}){let c=null,m=!1,y=null,_=!1;const v=e=>{_&&void 0===e||(y&&y(e),c=e)},w=[],k=()=>c;function T(n,t){return r(Number(t))?(v(k()[t]),N):(e.push(t),N)}function j(e){m&&n("1 with per chute"),m=!0,1===e.length&&o(e[0])||n(".with accepts 1 object for settings"),(e=e[0]).token&&(t(e.token)?(y=e.token,y(c)):n("token accepts `v=>your_variable=v`")),e.skip_void&&(_=Boolean(e.skip_void))}function A(f,u,c){if(0==e.length)return 0===c.length?k():(v(h(c,k())),N);let m=e.length-1;return e.reduce(((f,u,y)=>e.length>1&&y!==m?("log"==u?n(".log needs parens"):"if"==u?n(".if needs 1-2 arguments"):"tap"==u?n(".tap needs 1 fn argument"):"do"===u?n(".do needs 1+ arguments"):r(Number(u))?v(k()[u]):u&&b(w,u,k()),f):(1!==e.length&&y!==m||("log"==u?console.log(...c,k()):"with"==u?j(c):"if"==u?v((({args:e,data:r})=>{if(2==e.length)return(({when:e,then:n,data:r})=>{let i=e;t(e)&&(s(e),i=g(e,r,[]));if(i&&t(n))return s(n),g(n,r,[]);if(i)return n;return r})({when:e[0],then:e[1],data:r});if(1==e.length&&o(e[0])&&function(e){const n=Object.keys(e),t=e=>0 in e&&1 in e;if(!("if"in e&&i(e.if)&&t(e.if)))return!1;const r=("else"in e)+("else_if"in e);if("else_if"in e){if(!i(e.else_if))return!1;if(e.else_if.length>0&&!e.else_if.every((e=>i(e)&&t(e))))return!1}return n.length-1-r==0&&r<=2}(e[0])){let n=function(e,n){function r({condition:e,data:n}){return t(e)?e(n):e}if([e.if,...e.else_if].forEach((([e,n])=>{t(e)&&s(e),t(n)&&s(n)})),r({condition:e.if[0],data:n}))return e.if[1];if("else_if"in e)for(const[t,i]of e.else_if)if(r({condition:t,data:n}))return i;if("else"in e)return e.else;return n}(e[0],r);return r===n?r:t(n)?g(n,r,[]):n}return n(".if block incorrect",e),r})({args:c,data:k()})):"tap"==u?t(c[0])?c[0](k()):n("give .tap a fn to send data to"):"do"===u?v(h(c,k())):u&&(w.length>0?(v(b(w,u,k(),c)),w.length=0):v(((e,r,i)=>{if(t(e[r])){let n=e[r](...d(i,e));return p.has(r)?e:n}if(l(r)){let n=globalThis[r];return g(n,e,i)}return a.has(r)?g(a.get(r),e,i):(n(`"${r}" not in data nor a global function`),e)})(k(),u,c))),e.length=0),f)),N)}let N=new Proxy((()=>{}),{get:T,apply:A});v(f),u.length>0&&v(h(u,f));return N}({seed:f,fns:u});function s(e){return e.name&&!l(e.name)&&(a.has(e.name)||a.set(e.name,e)),e}function c(e,n){return"log"===n?(console.log(e),e):t(n)?(s(n),n(e)):n}u.x=f;const h=(e,n)=>e.reduce(c,n),g=(e,n,t)=>{if(0===t.length)return e(n);let r=d(t,n);return r!==t?e(...r):e(...t)(n)},d=(e,n)=>e.length>0&&-1!==e.indexOf(f)?e.map((e=>e===f?n:e)):e,p=new Set(["forEach","push","unshift"]);function b(e,r,i,o){if(e.push(r),!o)return;let l,a=void 0!==i[e[0]]?i:globalThis;let f=e.reduce(((t,r,i)=>{if(void 0!==t[r])return t=t[r],i<e.length-1&&(l=t),t;console.log(t[r]),n(`"${r}" not found at path: "${a===globalThis?"GlobalThis":"CurrentData"}.${e.join(".")}"`)}),a);return t(f)?a===i?f.call(l,...d(o,i)):g(f,i,o):i}return u})();