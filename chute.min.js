/*https://gregabbott.github.io/chute By + (C) Greg Abbott 2024. V: 2024-12-06*/
const chute=(()=>{const t=[],e=(...t)=>{throw new Error(t)},a=t=>t instanceof Function,n=t=>Array.isArray(t),i=t=>t&&"object"==typeof t&&!Array.isArray(t),r=t=>e=>{for(let a in e)if(!1===t(a,e[a],e))break},o={},s={},l=(n,...i)=>function({seed:n,args:i}){let r={data:null,fns_seen:{},with_received:!1,sync_data:null,skip_void:!0};r.keep=function(t){return e=>{let n=e.name;return n&&!a(globalThis[n])&&!t.fns_seen[n]&&(t.fns_seen[n]=e),e}}(r),r.set_data=t=>{r.skip_void&&void 0===t||(r.sync_data&&r.sync_data(t),r.data=t)},r.get_data=()=>r.data,r.set_data(n),i.length>0&&r.set_data(o.do({args:i,data:n,a_chute:r}));function s(e,a){return t.push(a),d}function f(n,i,s){let f=0==t.length;return f&&0===s.length?r.get_data():f&&s.length>0?(r.set_data(o.do({args:s,data:r.get_data(),a_chute:r})),d):(r.set_data(function({keys:t,args:n,a_chute:i,chute_lib:r}){let o=i.get_data(),s=i.skip_void;function f(t,a){let n="a built in chute method, a method of the_current_data, a global function, a function passed in to this chute via a previous call, or Chute's .feed or .lift properties";if(r.hasOwnProperty(t))return["chute_lib",r];if(null!==a.data&&void 0!==a.data[t])return["the_current_data",a.data];if(i.fns_seen[t])return["memoized_function",i.fns_seen];if(l.library[t])return["Feed_lib",l.library];let o=l.lifted_libraries.find((e=>e[t]));return o?["Lift_lib",o]:void 0!==globalThis[t]?["global_this",globalThis]:void e(`"${t}" is not: ${n}`)}return t.reduce(((e,a,i,r)=>{if(e.path||([e.root_string,e.root]=f(a,e),e.path=e.root,e.context=e.root),e.path=e.path[a],i==r.length-1)return d({fn:e.path,key:a,a:e,args:n});let o=t[i+1];return void 0===e.path[o]&&(e.data=d({fn:e.path,key:a,a:e}),e.path=null),e.context=e.path,e}),{path:null,data:o,context:null,root:null});function d({fn:t,key:n,a:o,args:f=[]}){let d;return a(o.path)||e(`${o.root_string}'s â€¦ "${n}" is not a FN`),o.root==r?d=t({args:f,data:o.data,a_chute:i}):o.root===globalThis||o.root==i.fns_seen||o.root==l.library||"Lift_lib"==o.root_string?d=h({fn:t,data:o.data,args:f}):(d=t.call(o.context,..._(f,o.data)),d=g.has(n)?o.data:d),s&&void 0===d?o.data:d}}({keys:t,a_chute:r,args:s,chute_lib:o})),t.length=0,d)}let d=new Proxy((()=>{}),{get:s,apply:f});return d}({seed:n,args:i});l.x=s,l.library={},l.lifted_libraries=[];const f=(t,e)=>{i(e)&&(l.library[t]=e,l.lifted_libraries.push(e))};function d(t){i(t)||e("give .lift 1 object"),r(f)(t)}l.lift=d;const c=(t,e)=>{(a(e)||i(e))&&(l.library[t]=e)};function u(t){i(t)||e("feed accepts an objects"),r(c)(t)}l.feed=u,o.log=({args:t,data:e})=>(t.length>0?console.log(...t,e):console.log(e),e),o.do=({args:t,data:n,a_chute:i})=>(0==t.length&&e(".do needs 1+ arguments"),t.reduce(((t,e)=>"log"===e?(console.log(t),t):a(e)?(i.keep(e),e(t)):e),n));const h=({fn:t,data:e,args:a})=>{if(0===a.length)return t(e);let n=_(a,e);return n!==a?t(...n):t(...a)(e)},_=(t,e)=>t.length>0&&t.includes(s)?t.map((t=>t===s?e:t)):t,g=new Set(["forEach","push","unshift"]);o.if=({args:t,data:r,a_chute:o})=>{0==t.length&&e(".if needs 1-2 arguments");let s=2===t.length?{if:t}:1===t.length&&t[0];if(function(t){if(!i(t))return!1;const e=Object.keys(t),a=t=>0 in t&&1 in t;if(!("if"in t&&n(t.if)&&a(t.if)))return!1;const r=("else"in t)+("else_if"in t);if("else_if"in t){if(!n(t.else_if))return!1;if(t.else_if.length>0&&!t.else_if.every((t=>n(t)&&a(t))))return!1}return 0==e.length-1-r&&r<=2}(s)){let t=function(t,e,n){function i({condition:t,data:e}){return a(t)?t(e):t}if((t.else_if?[t.if,...t.else_if]:[t.if]).forEach((([t,e])=>{a(t)&&n.keep(t),a(e)&&n.keep(e)})),i({condition:t.if[0],data:e}))return t.if[1];if("else_if"in t)for(const[a,n]of t.else_if)if(i({condition:a,data:e}))return n;return"else"in t?(a(t.else)&&n.keep(t.else),t.else):e}(s,r,o);return r===t?r:a(t)?h({fn:t,data:r,args:[]}):t}return e(".if block incorrect",t),r},o.tap=({args:t,data:n})=>{let i=t[0];return a(i)?i(n):e("give .tap a fn to send data to"),n},o.with=({args:t,data:n,a_chute:r})=>{let o=t;return r.with_received&&e("1 with per chute"),r.with_received=!0,1===o.length&&i(o[0])||e(".with accepts 1 object for settings"),o=o[0],o.sync&&function(t,n){a(t)||e('"sync" takes "v=>external_variable=v"');n.sync_data=t,n.sync_data(n.get_data())}(o.sync,r),o.skip_void&&(r.skip_void=!!o.skip_void),o.feed&&u(o.feed),o.lift&&d(o.lift),n};return l})();