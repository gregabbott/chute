/*https://gregabbott.github.io/chute By + (C) Greg Abbott 2024. V: 2024-12-07.3*/
const chute=(()=>{const t=(...t)=>{throw new Error(t)},e=t=>t instanceof Function,a=t=>Array.isArray(t),i=t=>t&&"object"==typeof t&&!Array.isArray(t),n=t=>e=>{for(let a in e)if(!1===t(a,e[a],e))break},r=(t,e)=>{i(e)&&(_.library[t]=e,_.lifted_libraries.push(e))},l=e=>{i(e)||t("give .lift 1 object"),n(r)(e)},s=(t,a)=>{(e(a)||i(a))&&(_.library[t]=a)},o=e=>{i(e)||t("give .feed 1 object"),n(s)(e)},d={},f={},_=(a,...i)=>function({seed:a,args:i}){let n={data:null,fns_seen:{},with_received:!1,treat_dots_as_paths:!1,sync_data:null,skip_void:!0,dot_list:[]};n.keep=(t=>a=>{let i=a.name;return i&&!e(globalThis[i])&&!t.fns_seen[i]&&(t.fns_seen[i]=a),a})(n),n.set_data=t=>{n.skip_void&&void 0===t||(n.sync_data&&n.sync_data(t),n.data=t)},n.get_data=()=>n.data,n.set_data(a),i.length>0&&n.set_data(d.do({args:i,data:a,a_chute:n}));function r(t,e){return n.dot_list.push(e),s}function l(a,i,r){let l=["_end","_$"].includes(n.dot_list.at(-1));l&&n.dot_list.pop();let o,f=0==n.dot_list.length,g=f&&r.length>0,p=f&&0===r.length,v=n.dot_list.length>0,b=p||l;return g?o=d.do({args:r,data:n.get_data(),a_chute:n}):v&&(o=function(a,i){let n=a.dot_list,r=a.get_data(),l=a.skip_void;function s(e,i){let n="a built in chute method, a method of the_current_data, a global function, a function passed in to this chute via a previous call, or Chute's .feed or .lift properties";if(d.hasOwnProperty(e))return["chute_lib",d];if(null!==i.data&&void 0!==i.data[e])return["the_current_data",i.data];if(a.fns_seen[e])return["memoized_function",a.fns_seen];if(_.library[e])return["Feed_lib",_.library];let r=_.lifted_libraries.find((t=>t[e]));return r?["Lift_lib",r]:void 0!==globalThis[e]?["global_this",globalThis]:void t(`"${e}" is not: ${n}`)}let o=a.treat_dots_as_paths;return n.reduce(((e,a,r,l)=>{if(e.path||([e.root_string,e.root]=s(a,e),e.path=e.root,e.context=e.root),e.path=e.path[a],r==l.length-1)return f({fn:e.path,key:a,a:e,args:i});let d=n[r+1];return void 0===e.path[d]&&(o&&t(`"${a}" lacks "${d}"`),e.data=f({fn:e.path,key:a,a:e}),e.path=null),e.context=e.path,e}),{path:null,data:r,context:null,root:null});function f({fn:i,key:n,a:r,args:s=[]}){let o;return e(r.path)||t(`${r.root_string}â€¦"${n}" not Æ’`),r.root==d?o=i({args:s,data:r.data,a_chute:a}):r.root===globalThis||r.root==a.fns_seen||r.root==_.library||"Lift_lib"==r.root_string?o=u({fn:i,data:r.data,args:s}):(o=i.call(r.context,...h(s,r.data)),o=c.has(n)?r.data:o),l&&void 0===o?r.data:o}}(n,r)),o&&n.set_data(o),n.dot_list.length=0,b?n.get_data():s}let s=new Proxy((()=>{}),{get:r,apply:l});return s}({seed:a,args:i});_.x=f,_.library={},_.lifted_libraries=[],_.lift=l,_.feed=o,d.log=({args:t,data:e})=>(t.length>0?console.log(...t,e):console.log(e),e),d.do=({args:a,data:i,a_chute:n})=>(0==a.length&&t("give .do >0 arguments"),a.reduce(((t,a)=>"log"===a?(console.log(t),t):e(a)?(n.keep(a),a(t)):a),i));const u=({fn:t,data:e,args:a})=>{if(0===a.length)return t(e);let i=h(a,e);return i!==a?t(...i):t(...a)(e)},h=(t,e)=>t.length>0&&t.includes(f)?t.map((t=>t===f?e:t)):t,c=new Set(["forEach","push","unshift"]);d.if=({args:n,data:r,a_chute:l})=>{0==n.length&&t(".if needs 1-2 arguments");let s=2===n.length?{if:n}:1===n.length&&n[0];if((t=>{if(!i(t))return!1;if(!1 in t)return!1;const e=t=>a(t)&&2===t.length&&0 in t&&1 in t;let n=Object.entries(t).reduce(((t,[i,n])=>("if"==i&&a(n)&&e(n)?t.valid[i]=n:"else_if"==i?t[a(n)&&n.map(e).filter((t=>!t)).length<1?"valid":"invalid"][i]=n:"else"==i?t.valid[i]=n:t.invalid[i]=n,t)),{valid:{},invalid:{}});return 0===Object.keys(n.invalid).length})(s)){let t=((t,a,i)=>{function n({q:t,data:a}){return e(t)?t(a):t}if((t.else_if?[t.if,...t.else_if]:[t.if]).forEach((([t,a])=>{e(t)&&i.keep(t),e(a)&&i.keep(a)})),n({q:t.if[0],data:a}))return t.if[1];if("else_if"in t)for(let[e,i]of t.else_if)if(n({q:e,data:a}))return i;return"else"in t?(e(t.else)&&i.keep(t.else),t.else):a})(s,r,l);return r===t?r:e(t)?u({fn:t,data:r,args:[]}):t}return t(".if block incorrect",n),r},d.tap=({args:a,data:i})=>{let n=a[0];return e(n)?n(i):t("give .tap a fn to send data to"),i},d.with=({args:a,data:n,a_chute:r})=>{let s=a;return r.with_received&&t("1 with per chute"),r.with_received=!0,1===s.length&&i(s[0])||t(".with accepts 1 object for settings"),s=s[0],s.sync&&function(a,i){e(a)||t('give SYNC FN: "v=>user_variable=v"');i.sync_data=a,i.sync_data(i.get_data())}(s.sync,r),s.skip_void&&(r.skip_void=!!s.skip_void),s.feed&&o(s.feed),s.lift&&l(s.lift),s.path&&(r.treat_dots_as_paths=!!s.path),n};return _})();