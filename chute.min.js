/*https://gregabbott.github.io/chute By + (C) Greg Abbott 2024. V: 2024-12-02.2*/
const chute=(()=>{const e=[],n=(...e)=>{throw new Error(e)},t=e=>e instanceof Function,r=e=>"number"==typeof e&&!isNaN(e),i=e=>Array.isArray(e),l=e=>t(globalThis[e]),o=new Map,a=(a,...s)=>function({seed:a,fns:s}){let p=null,b=null;const y=e=>{b&&b(e),p=e},m=[],w=()=>p;function _(n,t){return e.push(t),O}function v(a,s,_){if(0==e.length)return 0===_.length?w():(y(c(_,w())),O);let v=e.length-1;return e.reduce(((a,s,O)=>e.length>1&&O!==v?("log"==s?n(".log needs parens"):"if"==s?n(".if needs 1-2 arguments"):"tap"==s?n(".tap needs 1 fn argument"):"do"===s?n(".do needs 1+ arguments"):r(Number(s))?y(w()[s]):s&&d(m,s),a):(1!==e.length&&O!==v||("log"==s?console.log(..._,w()):"with"==s?null!==b?n("already set up. 1 with per chute"):1===_.length&&t(_[0])?(b=_[0],b(p)):n("with accepts v=>your_variable=v"):"if"==s?y((({args:e,data:r})=>{if(2==e.length)return(({when:e,then:n,data:r})=>{let i=e;t(e)&&(u(e),i=g(e,r,[]));if(i&&t(n))return u(n),g(n,r,[]);if(i)return n;return r})({when:e[0],then:e[1],data:r});if(1==e.length&&(l=e[0],l&&"object"==typeof l&&!Array.isArray(l))&&function(e){const n=Object.keys(e),t=e=>0 in e&&1 in e;if(!("if"in e&&i(e.if)&&t(e.if)))return!1;const r=("else"in e)+("else_if"in e);if("else_if"in e){if(!i(e.else_if))return!1;if(e.else_if.length>0&&!e.else_if.every((e=>i(e)&&t(e))))return!1}return n.length-1-r==0&&r<=2}(e[0])){let n=function(e,n){function r({condition:e,data:n}){return t(e)?e(n):e}if([e.if,...e.else_if].forEach((([e,n])=>{t(e)&&u(e),t(n)&&u(n)})),r({condition:e.if[0],data:n}))return e.if[1];if("else_if"in e)for(const[t,i]of e.else_if)if(r({condition:t,data:n}))return i;if("else"in e)return e.else;return n}(e[0],r);return r===n?r:t(n)?g(n,r,[]):n}var l;return n(".if block incorrect"),r})({args:_,data:w()})):"tap"==s?t(_[0])?_[0](w()):n("give .tap a fn to send data to"):"do"===s?y(c(_,w())):r(Number(s))?(y(w()[s]),y(c(_,w()))):s&&(m.length>0?(y(d(m,s,w(),_)),m.length=0):y(((e,r,i)=>{if(a=e,u=r,t(Object.getPrototypeOf(a)[u])){let n=i.indexOf(f);-1!==n&&(i[n]=e);let t=e[r](...i);return h.has(r)?e:t}var a,u;if(l(r)){let n=globalThis[r];return g(n,e,i)}return o.has(r)?g(o.get(r),e,i):(n(`Data lacks "${r}" and not a global function`),e)})(w(),s,_))),e.length=0),a)),O)}let O=new Proxy((()=>{}),{get:_,apply:v});y(a),s.length>0&&y(c(s,a));return O}({seed:a,fns:s}),f={};function u(e){return e.name&&!l(e.name)&&(o.has(e.name)||o.set(e.name,e)),e}function s(e,n){return"log"===n?(console.log(e),e):t(n)?(u(n),n(e)):n}a.x=f;const c=(e,n)=>e.reduce(s,n),h=new Set(["forEach","push","unshift"]),g=(e,n,t)=>{if(0===t.length)return e(n);let r=t.indexOf(f);return-1!==r?(t[r]=n,e(...t)):e(...t)(n)};function d(e,r,i,l){e.push(r);let o=e.reduce(((t,r,i)=>{if(void 0!==t[r])return t=t[r];n(`"${r}" not found at global path: "${e.join(".")}"`)}),globalThis);if(i)return t(o)?g(o,i,l):i}return a})();