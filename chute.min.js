/*https://gregabbott.github.io/chute By + (C) Greg Abbott 2024. V: 2024-12-08.2*/
const chute=(()=>{const t=(...t)=>{throw new Error(t)},e=t=>t instanceof Function,a=t=>Array.isArray(t),n=t=>t&&"object"==typeof t&&!Array.isArray(t),i=t=>e=>{for(let a in e)if(!1===t(a,e[a],e))break},r={},s={},l=(t=s,...e)=>h({seed:t,args:e});l.make=(...e)=>{let a=1===e.length&&n(e[0])?e[0]:0;return a||t(".with accepts 1 object for settings"),h({settings:a})};const o=({settings:a,a_chute:n})=>{n.with_received&&t('1 "with" per chute'),n.with_received=!0;let i=a;i.sync&&function(a,n){e(a)||t('give SYNC FN: "v=>user_variable=v"');n.sync_data=a,n.sync_data(n.get_data())}(i.sync,n),"skip"in i&&(n.skip_void=!!i.skip),i.path&&(n.treat_dots_as_paths=!!i.path)};l.x=s,l.library={},l.lifted_libraries=[],l.lift=e=>(n(e)||t("give .lift 1 object"),i(((t,e)=>{n(e)&&(l.library[t]=e,l.lifted_libraries.push(e))}))(e),l),l.feed=a=>(n(a)||t("give .feed 1 object"),i(((t,a)=>{(e(a)||n(a))&&(l.library[t]=a)}))(a),l),r.log=({args:t,data:e})=>(t.length>0?console.log(...t,e):console.log(e),e),r.do=({args:a,data:n,a_chute:i})=>(0==a.length&&t("give .do >0 arguments"),a.reduce(((t,a)=>"log"===a?(console.log(t),t):e(a)?(i.keep(a),a(t)):a),n));const d=t=>a=>{let n=a.name;return n&&!e(globalThis[n])&&!t.fns_seen[n]&&(t.fns_seen[n]=a),a},u=({fn:t,data:e,args:a})=>{if(0===a.length)return t(e);let n=_(a,e);return n!==a?t(...n):t(...a)(e)},_=(t,e)=>t.length>0&&t.includes(s)?t.map((t=>t===s?e:t)):t,f=new Set(["forEach","push","unshift"]);function c(a,n){let i=a.dot_list,s=a.get_data(),o=a.skip_void;let d=a.treat_dots_as_paths;return i.reduce(((e,s,o,u)=>{if(e.path||([e.root_string,e.root]=function(e,n){if(r.hasOwnProperty(e))return["chute_lib",r];if(null!==n.data&&void 0!==n.data[e])return["the_current_data",n.data];if(a.fns_seen[e])return["memoized_function",a.fns_seen];if(l.library[e])return["Feed_lib",l.library];let i=l.lifted_libraries.find((t=>t[e]));return i?["Lift_lib",i]:void 0!==globalThis[e]?["global_this",globalThis]:void t(`"${e}" is not: a built in chute method; a method of the_current_data; a function passed in to this chute via a previous call, or Chute's .feed or .lift properties;or a global function.`)}(s,e),e.path=e.root,e.context=e.root),e.path=e.path[s],o==u.length-1)return c({fn:e.path,key:s,a:e,args:n});let _=i[o+1];return void 0===e.path[_]?(d&&t(`"${s}" lacks "${_}"`),e.data=c({fn:e.path,key:s,a:e}),e.path=null):e.context=e.path,e}),{path:null,data:s,context:null,root:null});function c({fn:n,key:i,a:s,args:d=[]}){let c;return e(s.path)||t(`${s.root_string}…"${i}" not ƒ`),s.root==r?c=n({args:d,data:s.data,a_chute:a}):s.root===globalThis||s.root==a.fns_seen||s.root==l.library||"Lift_lib"==s.root_string?c=u({fn:n,data:s.data,args:d}):(c=n.call(s.context,..._(d,s.data)),c=f.has(i)?s.data:c),void 0===c&&o?s.data:c}}r.pick=({args:i,data:r,a_chute:s})=>{0==i.length&&t(".if needs 1-2 arguments");let l=2===i.length?{if:i}:1===i.length&&i[0];if((t=>{if(!n(t))return!1;if(!1 in t)return!1;const e=t=>a(t)&&2===t.length&&0 in t&&1 in t;let i=Object.entries(t).reduce(((t,[n,i])=>("if"==n&&a(i)&&e(i)?t.valid[n]=i:"else_if"==n?t[a(i)&&i.map(e).filter((t=>!t)).length<1?"valid":"invalid"][n]=i:"else"==n?t.valid[n]=i:t.invalid[n]=i,t)),{valid:{},invalid:{}});return 0===Object.keys(i.invalid).length})(l)){let t=((t,a,n)=>{function i({q:t,data:a}){return e(t)?t(a):t}if((t.else_if?[t.if,...t.else_if]:[t.if]).forEach((([t,a])=>{e(t)&&n.keep(t),e(a)&&n.keep(a)})),i({q:t.if[0],data:a}))return t.if[1];if("else_if"in t)for(let[e,n]of t.else_if)if(i({q:e,data:a}))return n;return"else"in t?(e(t.else)&&n.keep(t.else),t.else):a})(l,r,s);return r===t?r:e(t)?u({fn:t,data:r,args:[]}):t}return t(".if block incorrect",i),r},r.tap=({args:a,data:n})=>{let i=a[0];return e(i)?i(n):t("give .tap a fn to send data to"),n};function h({seed:t,args:e,settings:a}){let n={data:null,fns_seen:{},with_received:!1,treat_dots_as_paths:!1,sync_data:null,skip_void:!0,dot_list:[]};return n.keep=d(n),n.set_data=t=>{void 0===t&&n.skip_void||(n.sync_data&&n.sync_data(t),n.data=t)},n.get_data=()=>n.data,a&&o({settings:a,a_chute:n}),t&&n.set_data(t),e?.length>0&&n.set_data(r.do({args:e,data:t,a_chute:n})),n.proxy=new Proxy((()=>{}),{get:(t,e)=>(function(t,e){t.dot_list.push(e)}(n,e),n.proxy),apply:(t,e,a)=>function(t,e){let a=["_end","_$"].includes(t.dot_list.at(-1));a&&t.dot_list.pop();let n,i=0==t.dot_list.length,s=i&&e.length>0,l=!i,o=i&&0===e.length||a,d=s||l;return s?n=r.do({args:e,data:t.get_data(),a_chute:t}):l&&(n=c(t,e)),d&&t.set_data(n),t.dot_list.length=0,o?t.get_data():t.proxy}(n,a)}),n.proxy}return l})();