/*https://gregabbott.github.io/chute By + (C) Greg Abbott 2024. V: 2024-12-08.1*/
const chute=(()=>{const t=(...t)=>{throw new Error(t)},e=t=>t instanceof Function,a=t=>Array.isArray(t),r=t=>t&&"object"==typeof t&&!Array.isArray(t),i=t=>e=>{for(let a in e)if(!1===t(a,e[a],e))break},n=e=>{r(e)||t("give .lift 1 object"),i(((t,e)=>{r(e)&&(d.library[t]=e,d.lifted_libraries.push(e))}))(e)},l=a=>{r(a)||t("give .feed 1 object"),i(((t,a)=>{(e(a)||r(a))&&(d.library[t]=a)}))(a)},o={},s={},d=(a,...r)=>function({seed:a,args:r}){let i={data:null,fns_seen:{},with_received:!1,treat_dots_as_paths:!1,sync_data:null,skip_void:!0,dot_list:[]};i.keep=(t=>a=>{let r=a.name;return r&&!e(globalThis[r])&&!t.fns_seen[r]&&(t.fns_seen[r]=a),a})(i),i.set_data=t=>{void 0===t&&i.skip_void||(i.sync_data&&i.sync_data(t),i.data=t)},i.get_data=()=>i.data,a&&i.set_data(a);r.length>0&&i.set_data(o.do({args:r,data:a,a_chute:i}));return i.proxy=new Proxy((()=>{}),{get:(t,e)=>(function(t,e){t.dot_list.push(e)}(i,e),i.proxy),apply:(a,r,n)=>function(a,r){let i=["_end","_$"].includes(a.dot_list.at(-1));i&&a.dot_list.pop();let n,l=0==a.dot_list.length,s=l&&r.length>0,h=l&&0===r.length,c=!l,g=h||i,p=s||c;s?n=o.do({args:r,data:a.get_data(),a_chute:a}):c&&(n=function(a,r){let i=a.dot_list,n=a.get_data(),l=a.skip_void;function s(e,r){let i="a built in chute method, a method of the_current_data, a global function, a function passed in to this chute via a previous call, or Chute's .feed or .lift properties";if(o.hasOwnProperty(e))return["chute_lib",o];if(null!==r.data&&void 0!==r.data[e])return["the_current_data",r.data];if(a.fns_seen[e])return["memoized_function",a.fns_seen];if(d.library[e])return["Feed_lib",d.library];let n=d.lifted_libraries.find((t=>t[e]));return n?["Lift_lib",n]:void 0!==globalThis[e]?["global_this",globalThis]:void t(`"${e}" is not: ${i}`)}let h=a.treat_dots_as_paths;return i.reduce(((e,a,n,l)=>{if(e.path||([e.root_string,e.root]=s(a,e),e.path=e.root,e.context=e.root),e.path=e.path[a],n==l.length-1)return c({fn:e.path,key:a,a:e,args:r});let o=i[n+1];return void 0===e.path[o]?(h&&t(`"${a}" lacks "${o}"`),e.data=c({fn:e.path,key:a,a:e}),e.path=null):e.context=e.path,e}),{path:null,data:n,context:null,root:null});function c({fn:r,key:i,a:n,args:s=[]}){let h;return e(n.path)||t(`${n.root_string}â€¦"${i}" not Æ’`),n.root==o?h=r({args:s,data:n.data,a_chute:a}):n.root===globalThis||n.root==a.fns_seen||n.root==d.library||"Lift_lib"==n.root_string?h=f({fn:r,data:n.data,args:s}):(h=r.call(n.context,...u(s,n.data)),h=_.has(i)?n.data:h),void 0===h&&l?n.data:h}}(a,r));p&&a.set_data(n);return a.dot_list.length=0,g?a.get_data():a.proxy}(i,n)}),i.proxy}({seed:a,args:r});d.x=s,d.library={},d.lifted_libraries=[],d.lift=n,d.feed=l,o.log=({args:t,data:e})=>(t.length>0?console.log(...t,e):console.log(e),e),o.do=({args:a,data:r,a_chute:i})=>(0==a.length&&t("give .do >0 arguments"),a.reduce(((t,a)=>"log"===a?(console.log(t),t):e(a)?(i.keep(a),a(t)):a),r));const f=({fn:t,data:e,args:a})=>{if(0===a.length)return t(e);let r=u(a,e);return r!==a?t(...r):t(...a)(e)},u=(t,e)=>t.length>0&&t.includes(s)?t.map((t=>t===s?e:t)):t,_=new Set(["forEach","push","unshift"]);o.pick=({args:i,data:n,a_chute:l})=>{0==i.length&&t(".if needs 1-2 arguments");let o=2===i.length?{if:i}:1===i.length&&i[0];if((t=>{if(!r(t))return!1;if(!1 in t)return!1;const e=t=>a(t)&&2===t.length&&0 in t&&1 in t;let i=Object.entries(t).reduce(((t,[r,i])=>("if"==r&&a(i)&&e(i)?t.valid[r]=i:"else_if"==r?t[a(i)&&i.map(e).filter((t=>!t)).length<1?"valid":"invalid"][r]=i:"else"==r?t.valid[r]=i:t.invalid[r]=i,t)),{valid:{},invalid:{}});return 0===Object.keys(i.invalid).length})(o)){let t=((t,a,r)=>{function i({q:t,data:a}){return e(t)?t(a):t}if((t.else_if?[t.if,...t.else_if]:[t.if]).forEach((([t,a])=>{e(t)&&r.keep(t),e(a)&&r.keep(a)})),i({q:t.if[0],data:a}))return t.if[1];if("else_if"in t)for(let[e,r]of t.else_if)if(i({q:e,data:a}))return r;return"else"in t?(e(t.else)&&r.keep(t.else),t.else):a})(o,n,l);return n===t?n:e(t)?f({fn:t,data:n,args:[]}):t}return t(".if block incorrect",i),n},o.tap=({args:a,data:r})=>{let i=a[0];return e(i)?i(r):t("give .tap a fn to send data to"),r},o.with=({args:a,data:i,a_chute:o})=>{let s=a;return o.with_received&&t("1 with per chute"),o.with_received=!0,1===s.length&&r(s[0])||t(".with accepts 1 object for settings"),s=s[0],s.sync&&function(a,r){e(a)||t('give SYNC FN: "v=>user_variable=v"');r.sync_data=a,r.sync_data(r.get_data())}(s.sync,o),"skip"in s&&(o.skip_void=!!s.skip),s.feed&&l(s.feed),s.lift&&n(s.lift),s.path&&(o.treat_dots_as_paths=!!s.path),i};return d})();